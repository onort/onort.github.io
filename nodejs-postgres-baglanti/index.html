<!DOCTYPE html><html lang="tr"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Onort"><meta name="description" content="DatabaseOluşturİlkolarakbirdatabasevekullanıcıoluştur.12345sudo-upostgres-icreatedbdatabase_ismipsqldatabase_ismiCREATEUSERus"><meta name="keywords" content="node,postgres,database"><title>Node.js Postgres Bağlantı · Onort</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="https://onort.github.io/nodejs-postgres-baglanti/"><link rel="alternate" href="/atom.xml" title="Onort"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-313601-12', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Onort</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Ana Sayfa</a></li><li class="nav-link"><a href="/hepsi/" target="_self">Külliyat</a></li><li class="nav-link"><a href="/kategori/" target="_self">Kategorik</a></li><li class="nav-link"><a href="/etiket/" target="_self">Etiketli</a></li><li class="nav-link"><a href="/hakkinda/" target="_self">Nedir?</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Node.js Postgres Bağlantı</h1><span class="post-time">5 Kas 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">İçerik</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Database-Olustur"><span class="toc-text">Database Oluştur</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Knex"><span class="toc-text">Knex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PostgreSQL-Client"><span class="toc-text">PostgreSQL Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tablo-Olustur"><span class="toc-text">Tablo Oluştur</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ORM"><span class="toc-text">ORM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ornek"><span class="toc-text">Örnek</span></a></li></ol></div><div class="post-content"><h2 id="Database-Olustur"><a href="#Database-Olustur" class="headerlink" title="Database Oluştur"></a>Database Oluştur</h2><p>İlk olarak bir database ve kullanıcı oluştur.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo -u postgres -i</div><div class="line">createdb database_ismi</div><div class="line">psql database_ismi</div><div class="line">CREATE USER user-name WITH PASSWORD &quot;user-password&quot;</div><div class="line">GRANT ALL PRIVILEGES ON DATABASE &quot;database_ismi&quot; to username</div></pre></td></tr></table></figure>
<h2 id="Knex"><a href="#Knex" class="headerlink" title="Knex"></a>Knex</h2><p>Data senkronizasyonu ve migrasyonu için <a href="https://www.npmjs.com/package/knex" target="_blank" rel="external"><code>knex</code></a> adlı paketten yararlanabilirsin. Proje rootta <code>knex init</code> ile knexfile.js oluştur. Konfiguasyon bilgilerini <code>knexfile.js</code>‘e gir.</p>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ./knexfile.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line"></div><div class="line">  <span class="attr">development</span>: &#123;</div><div class="line">    <span class="attr">client</span>: <span class="string">'postgresql'</span>,</div><div class="line">    <span class="attr">connection</span>: &#123;</div><div class="line">      <span class="attr">database</span>: <span class="string">'database_ismi'</span>,</div><div class="line">      <span class="attr">user</span>:     <span class="string">'database_kullanici'</span>,</div><div class="line">      <span class="attr">password</span>: <span class="string">'db_sifre'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">pool</span>: &#123;</div><div class="line">      <span class="attr">min</span>: <span class="number">2</span>,</div><div class="line">      <span class="attr">max</span>: <span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">migrations</span>: &#123;</div><div class="line">      <span class="attr">tableName</span>: <span class="string">'knex_migrations'</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<h2 id="PostgreSQL-Client"><a href="#PostgreSQL-Client" class="headerlink" title="PostgreSQL Client"></a>PostgreSQL Client</h2><p>Node için postgres client’ını yükle.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --save pg</div></pre></td></tr></table></figure>
<p>Tablo için migration dosyası oluştur.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">knex migrate:make tablo_ismi</div></pre></td></tr></table></figure>
<h2 id="Tablo-Olustur"><a href="#Tablo-Olustur" class="headerlink" title="Tablo Oluştur"></a>Tablo Oluştur</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ./migrations/20161010xxxxxx_tablo-ismi.js</span></div><div class="line"></div><div class="line"><span class="comment">// tablo oluştur</span></div><div class="line">exports.up = <span class="function"><span class="keyword">function</span>(<span class="params">knex, Promise</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> knex.schema.createTable(<span class="string">'tablo_ismi'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">table</span>) </span>&#123;</div><div class="line">    table.increments(); <span class="comment">// increment ederek id oluştur.</span></div><div class="line">    table.string(<span class="string">'username'</span>).notNullable().unique();</div><div class="line">    table.string(<span class="string">'email'</span>).notNullable().unique();</div><div class="line">    table.string(<span class="string">'timezone'</span>).notNullable();</div><div class="line">    table.string(<span class="string">'password_digest'</span>).notNullable();</div><div class="line">    table.timestamps(); <span class="comment">// createAt ve updatedAt oluştur.</span></div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.down = <span class="function"><span class="keyword">function</span>(<span class="params">knex, Promise</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> knex.schema.dropTable(<span class="string">'tablo_ismi'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>knex migrate:latest</code> ile tabloyu migrate et.</p>
<h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><p><a href="https://www.npmjs.com/package/bookshelf" target="_blank" rel="external"><code>bookshelf</code></a> paketini ORM olark kullanabilirsin, knex ile çalışıyor. Bookshelf instance’ı oluştur.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server/bookshelf.js</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> knex <span class="keyword">from</span> <span class="string">'knex'</span>;</div><div class="line"><span class="keyword">import</span> bookshelf <span class="keyword">from</span> <span class="string">'bookshelf'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> knexConfig <span class="keyword">from</span> <span class="string">'../knexfile'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> bookshelf(knex(knexConfig.development));</div></pre></td></tr></table></figure>
<h2 id="Ornek"><a href="#Ornek" class="headerlink" title="Örnek"></a>Örnek</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server/models/user.js</span></div><div class="line"><span class="keyword">import</span> bookshelf <span class="keyword">from</span> <span class="string">'../bookshelf'</span>; <span class="comment">// Our initialized instance of bookshelf</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> bookshelf.Model.extend(&#123;</div><div class="line">  <span class="attr">tableName</span>: <span class="string">'users'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// server/routes/users.js</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> commonValidations <span class="keyword">from</span> <span class="string">'../shared/validations/signup'</span>;</div><div class="line"><span class="keyword">import</span> bcrypt <span class="keyword">from</span> <span class="string">'bcrypt'</span>;</div><div class="line"><span class="keyword">import</span> isEmpty <span class="keyword">from</span> <span class="string">'lodash/isEmpty'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> User <span class="keyword">from</span> <span class="string">'../models/user'</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateInput</span>(<span class="params">data, otherValidations</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> &#123; errors &#125; = otherValidations(data);</div><div class="line">  <span class="comment">// uniqueness check promise</span></div><div class="line">  <span class="keyword">return</span> User.query(&#123;</div><div class="line">    <span class="attr">where</span>: &#123; <span class="attr">email</span>: data.email &#125;,</div><div class="line">    <span class="attr">orWhere</span>: &#123; <span class="attr">username</span>: data.username &#125;</div><div class="line">  &#125;).fetch().then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (user) &#123;</div><div class="line">      <span class="keyword">if</span> (user.get(<span class="string">'username'</span>) === data.username) &#123;</div><div class="line">        errors.username = <span class="string">'There is user with such username'</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (user.get(<span class="string">'email'</span>) === data.email) &#123;</div><div class="line">        errors.email = <span class="string">'There is user with such email'</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        errors,</div><div class="line">        <span class="attr">isValid</span>: isEmpty(errors)</div><div class="line">    &#125;;</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"><span class="comment">// /users route</span></div><div class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</div><div class="line">  validateInput(req.body, commonValidations).then(<span class="function">(<span class="params">&#123; errors, isValid &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (isValid) &#123;</div><div class="line">      <span class="keyword">const</span> &#123; username, password, timezone, email &#125; = req.body;</div><div class="line">      <span class="keyword">const</span> password_digest = bcrypt.hashSync(password, <span class="number">10</span>);</div><div class="line">      User.forge(&#123;</div><div class="line">          username, timezone, email, password_digest</div><div class="line">        &#125;, &#123;</div><div class="line">          <span class="attr">hasTimestamps</span>: <span class="literal">true</span> &#125; <span class="comment">//options</span></div><div class="line">      ).save() <span class="comment">//returns a promise</span></div><div class="line">        .then(<span class="function"><span class="params">user</span> =&gt;</span> res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;))</div><div class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.status(<span class="number">500</span>).json(&#123; <span class="attr">error</span>: err &#125;));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.status(<span class="number">400</span>).json(errors);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">'/:identifier'</span>, (req, res) =&gt; &#123;</div><div class="line">  User.query(&#123;</div><div class="line">    <span class="attr">select</span>: [<span class="string">'username'</span>, <span class="string">'email'</span>],</div><div class="line">    <span class="attr">where</span>: &#123; <span class="attr">email</span>: req.params.identifier &#125;,</div><div class="line">    <span class="attr">orWhere</span>: &#123; <span class="attr">username</span>: req.params.identifier &#125;</div><div class="line">  &#125;).fetch().then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">    res.json(&#123; user &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</div></pre></td></tr></table></figure>
<p>Örnek <a href="https://www.youtube.com/playlist?list=PLuNEz8XtB51K-x3bwCC9uNM_cxXaiCcRY" target="_blank" rel="external">Rem Zolotykh</a>‘ın Youtube’da paylaştığı Redux - React tutorial’ından. <a href="https://github.com/Remchi/reddice" target="_blank" rel="external">Repo</a></p>
</div></article><div class="tags"><a href="/tags/node/">node</a><a href="/tags/postgres/">postgres</a><a href="/tags/database/">database</a></div><div class="paginator"><a href="/react-higher-order-component/" class="prev"><i class="iconfont icon-left"></i><span> Önceki</span></a><a href="/vs-code-kisayollar/" class="next"><span>Sonraki</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="social"><a href="https://github.com/onort" title="github" class="iconfont icon-github"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Onort</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>